{% extends "base.html" %}

{% block content %}
<!-- Loading State -->
<div id="loading" class="flex flex-col items-center justify-center py-20">
    <div class="relative">
        <div class="w-16 h-16 border-4 border-crypto-green/30 border-t-crypto-green rounded-full animate-spin"></div>
        <div class="absolute inset-0 w-16 h-16 border-4 border-transparent border-b-crypto-blue rounded-full animate-spin animation-delay-75"></div>
    </div>    <p id="loadingText" class="mt-6 text-gray-400 text-lg">Loading data...</p>
    <div class="mt-2 flex flex-col items-center space-y-3">
        <div class="flex space-x-1">
            <div class="w-2 h-2 bg-crypto-green rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-crypto-blue rounded-full animate-bounce animation-delay-100"></div>
            <div class="w-2 h-2 bg-crypto-purple rounded-full animate-bounce animation-delay-200"></div>
        </div>
        <div class="text-sm text-gray-500">Components will appear as they load</div>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden animate-fade-in">
    <!-- Metrics Cards -->
  <div class="glass-effect rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-gray-400 text-sm font-medium">Fear & Greed Index</p>
            <p id="fearGreedValue" class="text-2xl font-bold mt-1 text-white">-</p>
            <p id="fearGreedLabel" class="text-sm text-gray-400 mt-1">-</p>
            <p id="sellSignalText" class="text-sm font-semibold mt-2 hidden text-orange-400">ðŸ“¢ Sell signal: Extreme Greed</p>
        </div>
        <div class="w-12 h-12 bg-crypto-purple/20 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-crypto-purple" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12,2A10,10 0 1,1 2,12A10,10 0 0,1 12,2M13,7H11V13H13V7M13,15H11V17H13V15Z"/>
            </svg>
        </div>
    </div>
</div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-effect rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Total Balance</p>
                    <p id="totalBalance" class="text-2xl font-bold text-white mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-crypto-green/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-crypto-green" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="glass-effect rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Available Balance</p>
                    <p id="availableBalance" class="text-2xl font-bold text-white mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-crypto-blue/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-crypto-blue" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M11,8C11,7.45 11.45,7 12,7S13,7.45 13,8 12.55,9 12,9 11,8.55 11,8M18,6A3,3 0 0,1 21,9V19A3,3 0 0,1 18,22H6A3,3 0 0,1 3,19V9A3,3 0 0,1 6,6H7V4A5,5 0 0,1 12,-1A5,5 0 0,1 17,4V6H18M12,1A3,3 0 0,0 9,4V6H15V4A3,3 0 0,0 12,1Z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="glass-effect rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Total PnL</p>
                    <p id="totalPnL" class="text-2xl font-bold mt-1">-</p>
                </div>
                <div class="w-12 h-12 bg-crypto-purple/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-crypto-purple" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="glass-effect rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Positions</p>
                    <div id="positionCount" class="text-2xl font-bold text-white mt-1">-</div>
                </div>
                <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3,11H5A2,2 0 0,1 7,13V19A2,2 0 0,1 5,21H3A2,2 0 0,1 1,19V13A2,2 0 0,1 3,11M3,13V19H5V13H3M9,11H11A2,2 0 0,1 13,13V19A2,2 0 0,1 11,21H9A2,2 0 0,1 7,19V13A2,2 0 0,1 9,11M9,13V19H11V13H9M15,11H17A2,2 0 0,1 19,13V19A2,2 0 0,1 17,21H15A2,2 0 0,1 13,19V13A2,2 0 0,1 15,11M15,13V19H17V13H15M19,11H21A2,2 0 0,1 23,13V19A2,2 0 0,1 21,21H19A2,2 0 0,1 17,19V13A2,2 0 0,1 19,11M19,13V19H21V13H19Z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>    <!-- Individual Position Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8" id="individualCharts">
        <!-- Charts will be dynamically inserted here -->
    </div>

    <!-- Positions Table -->
    <div class="glass-effect rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Active Positions</h3>
            <div class="flex items-center space-x-2 text-sm text-gray-400">
                <div class="w-2 h-2 bg-crypto-green rounded-full animate-pulse"></div>
                <span>Real-time</span>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-700">
                        <th class="text-left py-3 px-4 font-medium text-gray-400">Pair</th>
                        <th class="text-left py-3 px-4 font-medium text-gray-400">Position</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">Size</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">Entry</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">Current</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">Liquidation</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">SL/TP</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">PnL</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">PnL %</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-400">Margin</th>
                        <th class="text-center py-3 px-4 font-medium text-gray-400">Leverage</th>
                        <th class="text-center py-3 px-4 font-medium text-gray-400">Type</th>
                    </tr>
                </thead>
                <tbody id="positionsTableBody" class="divide-y divide-gray-700">
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>    let refreshInterval;
    let retryCount = 0;
    const MAX_RETRIES = 3;
    const LOADING_STAGES = {
        WALLET: 'wallet',
        POSITIONS: 'positions',
        CHARTS: 'charts',
        FEAR_GREED: 'fear_greed'
    };
    
    const loadingStates = new Map();
    for (const stage of Object.values(LOADING_STAGES)) {
        loadingStates.set(stage, { loaded: false, error: null });
    }

    function updateLoadingUI() {
        const loadingEl = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        
        const totalStages = Object.keys(LOADING_STAGES).length;
        const loadedStages = Array.from(loadingStates.values()).filter(state => state.loaded).length;
        
        if (loadedStages === totalStages) {
            loadingEl.classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            return;
        }
        
        // Show which components are loading
        const pending = Object.entries(LOADING_STAGES)
            .filter(([_, stage]) => !loadingStates.get(stage).loaded)
            .map(([key, _]) => key.toLowerCase())
            .join(', ');
            
        loadingText.textContent = `Loading ${pending}...`;
    }

    function calculateLiquidationRisk(currentPrice, liquidationPrice) {
        if (!liquidationPrice || liquidationPrice === 0) return { level: 'low', text: 'N/A' };
        
        const distance = Math.abs((currentPrice - liquidationPrice) / currentPrice) * 100;
        
        if (distance < 5) return { level: 'high', text: 'HIGH' };
        if (distance < 15) return { level: 'medium', text: 'MED' };
        return { level: 'low', text: 'LOW' };
    }

    async function loadFearGreedIndex() {
        try {
            const res = await fetch('/api/fear-greed');
            const data = await res.json();

            if (data.error) {
                throw new Error(data.error);
            }

            const value = data.value;
            const label = data.classification;

            document.getElementById('fearGreedValue').textContent = value;
            document.getElementById('fearGreedLabel').textContent = label;

            const fgClass = value < 30 ? 'text-crypto-red'
                         : value < 60 ? 'text-yellow-400'
                         : 'text-crypto-green';
            document.getElementById('fearGreedValue').classList.add(fgClass);

            const sellSignal = document.getElementById('sellSignalText');
            if (value > 80) {
                sellSignal.textContent = "ðŸ“¢ Sell Signal: Market in Extreme Greed â€” Consider booking profits.";
                sellSignal.classList.remove('hidden');
            } else {
                sellSignal.classList.add('hidden');
            }

        } catch (err) {
            console.error("Fear & Greed fetch error:", err);
            document.getElementById('fearGreedValue').textContent = 'N/A';
            document.getElementById('fearGreedLabel').textContent = 'Unavailable';
            document.getElementById('sellSignalText').classList.add('hidden');
        }
    }    async function loadPortfolio() {
        // Reset all loading states
        for (const stage of Object.values(LOADING_STAGES)) {
            loadingStates.set(stage, { loaded: false, error: null });
        }
        updateLoadingUI();

        // Load wallet and positions data
        try {
            const response = await fetch('/api/portfolio');
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            
            const data = await response.json();
            if (data.error) throw new Error('API Error: ' + data.error);
            
            // Update wallet metrics immediately
            updateWalletMetrics(data.wallet, data.metrics);
            loadingStates.set(LOADING_STAGES.WALLET, { loaded: true, error: null });
            updateLoadingUI();
            
            // Update positions table next
            updatePositionsTable(data.positions);
            loadingStates.set(LOADING_STAGES.POSITIONS, { loaded: true, error: null });
            updateLoadingUI();

            // Show the dashboard as soon as basic data is loaded
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Load charts in the background
            loadCharts().then(() => {
                loadingStates.set(LOADING_STAGES.CHARTS, { loaded: true, error: null });
                updateLoadingUI();
            }).catch(err => {
                loadingStates.set(LOADING_STAGES.CHARTS, { loaded: false, error: err });
                console.warn('Charts failed to load:', err);
                updateLoadingUI();
            });
            
            // Load Fear & Greed index in parallel
            loadFearGreedIndex().then(() => {
                loadingStates.set(LOADING_STAGES.FEAR_GREED, { loaded: true, error: null });
                updateLoadingUI();
            }).catch(err => {
                loadingStates.set(LOADING_STAGES.FEAR_GREED, { loaded: false, error: err });
                console.warn('Fear & Greed index failed to load:', err);
                updateLoadingUI();
            });

            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            retryCount = 0;
            
        } catch (error) {
            console.error('Portfolio load error:', error);
            
            if (retryCount < MAX_RETRIES) {
                retryCount++;
                setTimeout(() => loadPortfolio(), 2000 * retryCount);
            } else {
                showError('Failed to load portfolio: ' + error.message);
            }
        }
    }
    
    function showError(message) {
        document.getElementById('loading').innerHTML = `
            <div class="text-center">
                <div class="w-16 h-16 bg-crypto-red/20 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-8 h-8 text-crypto-red" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-crypto-red mb-2">Connection Error</h3>
                <p class="text-gray-400 mb-6">${message}</p>
                <button onclick="location.reload()" class="bg-crypto-green hover:bg-crypto-green/80 px-6 py-3 rounded-xl font-medium transition-colors">
                    Retry Connection
                </button>
            </div>
        `;
    }
    
    function updateWalletMetrics(wallet, metrics) {
        document.getElementById('totalBalance').textContent = 
            `$${wallet.total_balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        
        document.getElementById('availableBalance').textContent = 
            `$${wallet.available_balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        
        const pnlElement = document.getElementById('totalPnL');
        const pnl = wallet.total_pnl;
        pnlElement.textContent = `$${pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        pnlElement.className = `text-2xl font-bold mt-1 ${pnl >= 0 ? 'text-crypto-green' : 'text-crypto-red'}`;
        
        document.getElementById('positionCount').innerHTML = 
            `<div class="text-2xl font-bold">${metrics.total_positions}</div>
            <div class="text-xs text-gray-400 mt-1">
                <span class="text-crypto-blue">${metrics.long_positions} LONG</span> â€¢ 
                <span class="text-orange-400">${metrics.short_positions} SHORT</span>
            </div>`;
    }
    
    function updatePositionsTable(positions) {
        const tbody = document.getElementById('positionsTableBody');
        tbody.innerHTML = '';
        
        positions.forEach((pos, index) => {
            const row = document.createElement('tr');
            const isLong = pos.active_pos > 0;
            const pnlPositive = pos.pnl >= 0;
            const liquidationRisk = calculateLiquidationRisk(pos.current_price, pos.liquidation_price || 0);
            
            row.className = `hover:bg-white/5 transition-colors animate-slide-up`;
            row.style.animationDelay = `${index * 50}ms`;
            
            row.innerHTML = `
                <td class="py-4 px-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-crypto-blue to-crypto-purple flex items-center justify-center text-white font-bold text-sm">
                            ${pos.pair.replace('B-', '').replace('_USDT', '').substring(0, 3)}
                        </div>
                        <span class="font-medium text-white">${pos.pair.replace('B-', '').replace('_USDT', '')}</span>
                    </div>
                </td>
                <td class="py-4 px-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${isLong ? 'bg-crypto-blue/20 text-crypto-blue' : 'bg-orange-500/20 text-orange-400'}">
                        ${isLong ? 'LONG' : 'SHORT'}
                    </span>
                </td>
                <td class="py-4 px-4 text-right text-white font-medium">
                    ${Math.abs(pos.active_pos).toLocaleString(undefined, {maximumFractionDigits: 4})}
                </td>
                <td class="py-4 px-4 text-right text-gray-300">
                    $${pos.avg_price.toLocaleString(undefined, {minimumFractionDigits: 2})}
                </td>
                <td class="py-4 px-4 text-right text-gray-300">
                    $${pos.current_price.toLocaleString(undefined, {minimumFractionDigits: 2})}
                </td>
                <td class="py-4 px-4 text-right">
                    ${pos.liquidation_price && pos.liquidation_price > 0 ? 
                        `<div>
                            <span class="text-gray-300">${pos.liquidation_price.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                            <div class="text-xs font-medium mt-1 ${
                                liquidationRisk.level === 'high' ? 'text-crypto-red' :
                                liquidationRisk.level === 'medium' ? 'text-yellow-400' : 'text-crypto-green'
                            }">${liquidationRisk.text}</div>
                        </div>` : 
                        '<span class="text-gray-500 text-sm">Cross</span>'
                    }
                </td>
                <td class="py-4 px-4 text-right">
                    <div class="space-y-1">
                        ${pos.stop_loss_trigger ? 
                            `<div class="text-xs"><span class="text-crypto-red">SL:</span> <span class="text-gray-300">${pos.stop_loss_trigger.toLocaleString(undefined, {minimumFractionDigits: 2})}</span></div>` : 
                            ''
                        }
                        ${pos.take_profit_trigger ? 
                            `<div class="text-xs"><span class="text-crypto-green">TP:</span> <span class="text-gray-300">${pos.take_profit_trigger.toLocaleString(undefined, {minimumFractionDigits: 2})}</span></div>` : 
                            ''
                        }
                        ${!pos.stop_loss_trigger && !pos.take_profit_trigger ? 
                            '<span class="text-gray-500 text-sm">-</span>' : 
                            ''
                        }
                    </div>
                </td>
                <td class="py-4 px-4 text-right font-bold ${pnlPositive ? 'text-crypto-green' : 'text-crypto-red'}">
                    $${pos.pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}
                </td>
                <td class="py-4 px-4 text-right font-medium ${pnlPositive ? 'text-crypto-green' : 'text-crypto-red'}">
                    ${pos.pnl_percent > 0 ? '+' : ''}${pos.pnl_percent.toFixed(2)}%
                </td>
                <td class="py-4 px-4 text-right text-gray-300">
                    $${pos.locked_margin.toLocaleString(undefined, {minimumFractionDigits: 2})}
                </td>
                <td class="py-4 px-4 text-center">
                    <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-sm font-medium">
                        ${pos.leverage}x
                    </span>
                </td>
                <td class="py-4 px-4 text-center">
                    <span class="px-2 py-1 rounded text-xs font-medium ${pos.margin_type === 'crossed' ? 'bg-crypto-green/20 text-crypto-green' : 'bg-gray-500/20 text-gray-400'}">
                        ${pos.margin_type.toUpperCase()}
                    </span>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        if (positions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="py-12 text-center text-gray-400">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 mb-4 opacity-50" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
                            </svg>
                            <p>No active positions</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }    // Global chart configuration and instances
    const chartConfig = {
        displayModeBar: false,
        responsive: true,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#ffffff', family: 'system-ui' }
    };

    // Store active charts and their data
    const activeCharts = new Map();
    let priceUpdateInterval;

    // Update price data for a specific chart
    async function updateChartPrice(pair, newPrice, historicalPrices) {
        const chartData = activeCharts.get(pair);
        if (!chartData) return;

        // Update price history with the new data
        chartData.prices = historicalPrices || [...chartData.prices.slice(1), newPrice];
        chartData.high = Math.max(...chartData.prices);
        chartData.low = Math.min(...chartData.prices);

        // Update chart
        const chart = document.getElementById(`chart-${pair}`);
        if (!chart) return;

        try {
            await Plotly.update(chart, {
                y: [chartData.prices]
            });

            // Update price display
            const priceDisplay = document.querySelector(`#chart-${pair}-price`);
            if (priceDisplay) {
                const priceChange = ((newPrice - chartData.prices[0]) / chartData.prices[0]) * 100;
                priceDisplay.innerHTML = `
                    <div class="price-info flex items-center justify-between mt-4">
                        <div>
                            <span class="text-white font-medium">$${newPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                            <span class="ml-2 ${priceChange >= 0 ? 'text-crypto-green' : 'text-crypto-red'}">
                                ${priceChange >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(priceChange).toFixed(2)}%
                            </span>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-400">H:</span>
                            <span class="text-crypto-green">$${chartData.high.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                            <span class="text-gray-400 ml-2">L:</span>
                            <span class="text-crypto-red">$${chartData.low.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.warn('Chart update failed:', error);
        }
    }

    // Fetch current prices for all active pairs
    async function fetchCurrentPrices() {
        try {
            const activePairs = Array.from(activeCharts.keys());
            if (activePairs.length === 0) return;

            const response = await fetch('/api/current-prices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pairs: activePairs })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            // Update each chart with new price data
            for (const [pair, priceData] of Object.entries(data)) {
                if (priceData.current && activeCharts.has(pair)) {
                    updateChartPrice(pair, priceData.current, priceData.historical);
                }
            }
        } catch (error) {
            console.warn('Failed to fetch current prices:', error);
        }
    }

    // Create and initialize a single chart
    async function createChart(container, pair, data, isLong) {
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container rounded-2xl p-6';
        
        // Create chart header
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-4';
        header.innerHTML = `
            <h3 class="text-lg font-semibold text-white">${pair}</h3>
            <span class="px-3 py-1 rounded-full text-xs font-medium ${
                isLong ? 'bg-crypto-blue/20 text-crypto-blue' : 'bg-orange-500/20 text-orange-400'
            }">${isLong ? 'LONG' : 'SHORT'}</span>
        `;
        
        // Create chart placeholder
        const plotDiv = document.createElement('div');
        plotDiv.className = 'h-80';
        plotDiv.id = `chart-${pair}`;
        
        // Create price display
        const priceDisplay = document.createElement('div');
        priceDisplay.id = `chart-${pair}-price`;
        
        chartDiv.appendChild(header);
        chartDiv.appendChild(plotDiv);
        chartDiv.appendChild(priceDisplay);
        container.appendChild(chartDiv);

        try {
            // Fetch historical prices from the local database
            const historyResponse = await fetch(`/api/price-history/${pair}`);
            if (!historyResponse.ok) throw new Error(`HTTP ${historyResponse.status}`);
            const historyData = await historyResponse.json();

            // Initialize price data with historical values
            const prices = historyData.prices || Array(96).fill(data.current);
            activeCharts.set(pair, {
                prices,
                high: Math.max(...prices),
                low: Math.min(...prices)
            });

            // Create the chart
            const times = Array.from({length: 96}, (_, i) => {
                const now = new Date();
                return new Date(now - (95 - i) * 15 * 60000);
            });

            const traces = [{
                x: times,
                y: prices,
                name: 'Price',
                type: 'scatter',
                line: { color: '#ffffff', width: 2 }
            }];

            // Add entry, liquidation, stop loss, and take profit lines
            if (data.entry) {
                traces.push({
                    x: [times[0], times[times.length - 1]],
                    y: [data.entry, data.entry],
                    name: 'Entry',
                    type: 'scatter',
                    line: { color: '#3742FA', width: 1, dash: 'dot' }
                });
            }

            if (data.liquidation) {
                traces.push({
                    x: [times[0], times[times.length - 1]],
                    y: [data.liquidation, data.liquidation],
                    name: 'Liquidation',
                    type: 'scatter',
                    line: { color: '#FF4757', width: 1, dash: 'dot' }
                });
            }

            if (data.stopLoss) {
                traces.push({
                    x: [times[0], times[times.length - 1]],
                    y: [data.stopLoss, data.stopLoss],
                    name: 'Stop Loss',
                    type: 'scatter',
                    line: { color: '#FF4757', width: 1, dash: 'dash' }
                });
            }

            if (data.takeProfit) {
                traces.push({
                    x: [times[0], times[times.length - 1]],
                    y: [data.takeProfit, data.takeProfit],
                    name: 'Take Profit',
                    type: 'scatter',
                    line: { color: '#00D4AA', width: 1, dash: 'dash' }
                });
            }

            const layout = {
                ...chartConfig,
                height: 320,
                margin: { t: 20, r: 10, l: 50, b: 30 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    x: 0.5,
                    xanchor: 'center',
                    bgcolor: 'rgba(0,0,0,0.3)',
                    font: { color: '#ffffff' }
                },
                yaxis: {
                    gridcolor: 'rgba(255,255,255,0.1)',
                    tickformat: ',.2f',
                    side: 'left',
                    autorange: true
                },
                xaxis: {
                    gridcolor: 'rgba(255,255,255,0.1)',
                    type: 'date',
                    tickformat: '%H:%M',
                    showgrid: true
                },
                dragmode: 'pan',
                hovermode: 'x unified'
            };

            await Plotly.newPlot(`chart-${pair}`, traces, layout, { 
                displayModeBar: false,
                responsive: true 
            });

            // Update initial price display
            updateChartPrice(pair, data.current, prices);

        } catch (error) {
            console.warn(`Failed to initialize chart for ${pair}:`, error);
            chartDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-crypto-red/20 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <svg class="w-6 h-6 text-crypto-red" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                        </svg>
                    </div>
                    <p class="text-gray-400">Failed to load chart</p>
                </div>
            `;
        }
    }

    // Modified loadCharts function
    async function loadCharts() {
        const chartsContainer = document.getElementById('individualCharts');
        chartsContainer.innerHTML = '<div class="col-span-full text-center"><div class="w-10 h-10 border-4 border-crypto-green/30 border-t-crypto-green rounded-full animate-spin mx-auto"></div><p class="mt-4 text-gray-400">Loading charts...</p></div>';
        
        // Clear existing update interval if any
        if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
            priceUpdateInterval = null;
        }

        // Clear existing charts
        activeCharts.clear();
            
        try {
            const response = await fetch('/api/charts');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const charts = await response.json();
            if (!charts || charts.error) throw new Error(charts?.error || 'No data');

            // Clear loading state
            chartsContainer.innerHTML = '';

            // Create charts in batches of 3 for better performance
            const pairs = charts.positions.data[0].x;
            const BATCH_SIZE = 3;
            
            for (let i = 0; i < pairs.length; i += BATCH_SIZE) {
                const batchPairs = pairs.slice(i, i + BATCH_SIZE);
                const batchPromises = batchPairs.map((pair, idx) => {
                    const absoluteIndex = i + idx;
                    const isLong = charts.positions.data[0].text[absoluteIndex] === 'Long';
                    const chartData = {
                        current: charts.prices.current[absoluteIndex],
                        entry: charts.prices.entry[absoluteIndex],
                        liquidation: charts.prices.liquidation[absoluteIndex],
                        stopLoss: charts.prices.stopLoss[absoluteIndex],
                        takeProfit: charts.prices.takeProfit[absoluteIndex]
                    };
                    return createChart(chartsContainer, pair, chartData, isLong);
                });

                // Wait for current batch to complete before moving to next
                await Promise.all(batchPromises);
            }

            // Start periodic price updates
            priceUpdateInterval = setInterval(fetchCurrentPrices, 15000); // Update every 15 seconds

            // Setup visibility change handler
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                        priceUpdateInterval = null;
                    }
                } else {
                    if (!priceUpdateInterval) {
                        fetchCurrentPrices(); // Immediate update when becoming visible
                        priceUpdateInterval = setInterval(fetchCurrentPrices, 15000);
                    }
                }
            });

        } catch (error) {
            console.warn('Failed to load charts:', error);
            chartsContainer.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <div class="w-12 h-12 bg-crypto-red/20 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <svg class="w-6 h-6 text-crypto-red" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                        </svg>
                    </div>
                    <p class="text-gray-400">Failed to load position charts</p>
                    <button onclick="retryLoadCharts()" class="mt-4 px-4 py-2 bg-crypto-green/20 hover:bg-crypto-green/30 text-crypto-green rounded-lg transition-colors">
                        Retry Loading Charts
                    </button>
                </div>
            `;
            throw error;
        }
    }

    async function retryLoadCharts() {
        try {
            await loadCharts();
        } catch (error) {
            console.error('Retry failed:', error);
        }
    }
</script>
{% endblock %}