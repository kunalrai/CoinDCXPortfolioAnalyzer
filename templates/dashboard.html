<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinDCX Futures Portfolio</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .long { color: #007bff; }
        .short { color: #fd7e14; }
        .chart-container { height: 400px; margin: 20px 0; }
        .loading { text-align: center; padding: 50px; }
        .position-card { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center mb-4">CoinDCX Futures Portfolio</h1>
        
        <div id="loading" class="loading">
            <div class="spinner-border" role="status"></div>
            <p>Loading futures data...</p>
        </div>
        
        <div id="dashboard" style="display: none;">
            <!-- Wallet Summary -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5>Total Balance</h5>
                            <h3 id="totalBalance">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5>Available Balance</h5>
                            <h3 id="availableBalance">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5>Total PnL</h5>
                            <h3 id="totalPnL">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5>Positions</h5>
                            <h6 id="positionCount">-</h6>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="row">
                <div class="col-md-6">
                    <div id="pnlChart" class="chart-container"></div>
                </div>
                <div class="col-md-6">
                    <div id="positionsChart" class="chart-container"></div>
                </div>
            </div>
            
            <!-- Positions Table -->
            <div class="row">
                <div class="col-12">
                    <h3>Active Positions</h3>
                    <div class="table-responsive">
                        <table id="positionsTable" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Pair</th>
                                    <th>Position</th>
                                    <th>Size</th>
                                    <th>Entry Price</th>
                                    <th>Current Price</th>
                                    <th>PnL</th>
                                    <th>PnL %</th>
                                    <th>Margin</th>
                                    <th>Leverage</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }
                
                updateWalletMetrics(data.wallet, data.metrics);
                updatePositionsTable(data.positions);
                loadCharts();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                showError('Failed to load portfolio: ' + error.message);
            }
        }
        
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4>Error</h4>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                </div>
            `;
        }
        
        function updateWalletMetrics(wallet, metrics) {
            document.getElementById('totalBalance').textContent = 
                `$${wallet.total_balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            
            document.getElementById('availableBalance').textContent = 
                `$${wallet.available_balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            
            const pnlElement = document.getElementById('totalPnL');
            const pnl = wallet.total_pnl;
            pnlElement.textContent = `$${pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            pnlElement.className = pnl >= 0 ? 'positive' : 'negative';
            
            document.getElementById('positionCount').innerHTML = 
                `${metrics.total_positions} total<br/>
                <span class="long">${metrics.long_positions} long</span> | 
                <span class="short">${metrics.short_positions} short</span>`;
        }
        
        function updatePositionsTable(positions) {
            const tbody = document.querySelector('#positionsTable tbody');
            tbody.innerHTML = '';
            
            positions.forEach(pos => {
                const row = tbody.insertRow();
                const isLong = pos.active_pos > 0;
                
                row.innerHTML = `
                    <td><strong>${pos.pair.replace('B-', '').replace('_USDT', '')}</strong></td>
                    <td class="${isLong ? 'long' : 'short'}">${isLong ? 'LONG' : 'SHORT'}</td>
                    <td>${Math.abs(pos.active_pos).toLocaleString(undefined, {maximumFractionDigits: 4})}</td>
                    <td>$${pos.avg_price.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td>$${pos.current_price.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="${pos.pnl >= 0 ? 'positive' : 'negative'}">$${pos.pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="${pos.pnl_percent >= 0 ? 'positive' : 'negative'}">${pos.pnl_percent.toFixed(2)}%</td>
                    <td>$${pos.locked_margin.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td>${pos.leverage}x</td>
                    <td><span class="badge ${pos.margin_type === 'crossed' ? 'bg-primary' : 'bg-secondary'}">${pos.margin_type}</span></td>
                `;
            });
        }
        
        async function loadCharts() {
            try {
                const response = await fetch('/api/charts');
                
                if (!response.ok) {
                    console.error('Charts API failed:', response.status);
                    return;
                }
                
                const charts = await response.json();
                
                if (charts.error) {
                    console.error('Chart error:', charts.error);
                    return;
                }
                
                Plotly.newPlot('pnlChart', charts.pnl.data, charts.pnl.layout);
                Plotly.newPlot('positionsChart', charts.positions.data, charts.positions.layout);
            } catch (error) {
                console.error('Failed to load charts:', error);
            }
        }
        
        // Load portfolio on page load
        loadPortfolio();
        
        // Auto-refresh every 30 seconds (futures are more active)
        setInterval(loadPortfolio, 30000);
    </script>
</body>
</html>